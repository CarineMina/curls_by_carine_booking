<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... باقي head كما هو ... -->
</head>
<body>
    <!-- ... باقي الهيكل كما هو ... -->

    <script>
        // ... المتغيرات والدوال الأخرى كما هي ...

        // تعديل دالة الحجز لتجنب الحجز المزدوج
        function confirmBooking() {
            const form = document.querySelector('#booking form');
            const formData = new FormData(form);
            
            // إنشاء موعد جديد
            const newAppointment = {
                id: Date.now().toString(),
                date: booking.date,
                time: booking.time,
                name: formData.get('name'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                services: booking.services,
                hairstyle: booking.hairstyle,
                total: parseFloat(document.getElementById('form-total').value),
                completed: false
            };
            
            // الحصول على المواعيد الحالية
            const savedAppointments = localStorage.getItem('appointments') || '[]';
            const appointments = JSON.parse(savedAppointments);
            
            // التحقق من عدم وجود حجز مسبق لنفس الوقت
            const isAlreadyBooked = appointments.some(app => 
                app.date === newAppointment.date && 
                app.time === newAppointment.time &&
                !app.completed
            );
            
            if (isAlreadyBooked) {
                alert('This time slot has been booked by someone else. Please select another time.');
                return false;
            }
            
            // إضافة الحجز الجديد
            appointments.push(newAppointment);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            // عرض رسالة التأكيد
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('confirmation').classList.remove('hidden');
            
            return false; // لمنع إرسال النموذج التقليدي (سنستخدم FormSubmit)
        }

        // تعديل دالة تحميل المواعيد المتاحة
        function loadAvailableTimeSlots() {
            timeSlotsContainer.innerHTML = '';
            
            if (!booking.date) {
                timeSlotsContainer.innerHTML = '<p>Please select a date first</p>';
                return;
            }
            
            const savedSlots = localStorage.getItem('availableSlots') || '[]';
            const slots = JSON.parse(savedSlots);
            
            const savedAppointments = localStorage.getItem('appointments') || '[]';
            const appointments = JSON.parse(savedAppointments);
            
            // تصفية المواعيد المحجوزة
            const bookedTimes = appointments
                .filter(app => app.date === booking.date && !app.completed)
                .map(app => app.time);
            
            // عرض المواعيد المتاحة فقط
            slots
                .filter(slot => slot.date === booking.date)
                .forEach(slot => {
                    const isBooked = bookedTimes.includes(slot.time);
                    const slotElement = document.createElement('div');
                    slotElement.className = `time-slot ${isBooked ? 'booked' : ''}`;
                    slotElement.textContent = slot.time;
                    
                    if (!isBooked) {
                        slotElement.onclick = function() { selectTime(this, slot.time); };
                    }
                    
                    timeSlotsContainer.appendChild(slotElement);
                });
            
            if (timeSlotsContainer.children.length === 0) {
                timeSlotsContainer.innerHTML = '<p>No available times for selected date</p>';
            }
        }

        // تعديل دالة nextStep للتحقق من تحديد الوقت
        function nextStep(step) {
            if (step === 2) {
                if (booking.services.length === 0 && !booking.hairstyle) {
                    alert('Please select at least one service');
                    return;
                }
                
                if (booking.hairstyle && !document.getElementById('hairstyle-photo').files[0]) {
                    alert('Please upload an inspiration photo for your hairstyle');
                    return;
                }
                
                if (!booking.time) {
                    alert('Please select a time slot for your appointment');
                    return;
                }
                
                // ... باقي الكود ...
            }
            
            // ... تغيير الخطوات ...
        }

        // تعديل دالة عرض المواعيد في لوحة التحكم
        function updateAppointmentsTable() {
            appointmentsTable.innerHTML = '';
            
            const savedAppointments = localStorage.getItem('appointments') || '[]';
            const appointments = JSON.parse(savedAppointments)
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (appointments.length === 0) {
                appointmentsTable.innerHTML = '<tr><td colspan="7">No appointments found</td></tr>';
                return;
            }
            
            appointments.forEach(app => {
                const row = document.createElement('tr');
                if (app.completed) row.classList.add('completed');
                
                let servicesText = '';
                if (app.services) {
                    servicesText = app.services.map(s => s.name).join(', ');
                }
                if (app.hairstyle) {
                    servicesText += servicesText ? ', ' + app.hairstyle.name : app.hairstyle.name;
                }
                
                row.innerHTML = `
                    <td style="text-align: center;">
                        <input type="checkbox" class="completed-checkbox" ${app.completed ? 'checked' : ''}
                            onchange="toggleAppointmentCompletion('${app.id}', this.checked)">
                    </td>
                    <td>${formatDate(app.date)}</td>
                    <td>${app.time}</td>
                    <td>${app.name}</td>
                    <td>${servicesText || 'N/A'}</td>
                    <td>${app.total ? app.total + ' EGP' : 'N/A'}</td>
                    <td class="action-btns">
                        <button class="btn btn-danger btn-sm" onclick="cancelAppointment('${app.id}')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </td>
                `;
                
                appointmentsTable.appendChild(row);
            });
        }

        // ... باقي الدوال كما هي ...
    </script>
</body>
</html>
